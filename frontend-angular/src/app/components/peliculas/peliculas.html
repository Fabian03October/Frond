<app-navbar></app-navbar>

<div class="peliculas-container">
  <!-- Main Content -->
  <main class="main-content">
    <!-- Header y b√∫squeda -->
    <div class="header-section">
      <h1>üé¨ Galer√≠a de Pel√≠culas</h1>
      <div class="search-section">
        <input 
          type="text" 
          [(ngModel)]="searchTerm" 
          (input)="searchPeliculas()"
          placeholder="üîç Buscar por t√≠tulo, g√©nero o director..."
          class="search-input">
      </div>
    </div>

    <!-- Loading -->
    <div *ngIf="loading" class="loading">
      <p>‚è≥ Cargando pel√≠culas...</p>
    </div>

    <!-- Vista de galer√≠a de pel√≠culas -->
    <div *ngIf="!loading && !selectedPelicula" class="peliculas-grid">
      <div *ngFor="let pelicula of peliculasFiltradas" class="pelicula-card" (click)="verDetalle(pelicula)">
        <div class="pelicula-poster">
          <img [src]="pelicula.url_imagen || '/assets/no-image.jpg'" [alt]="pelicula.titulo">
          <div class="pelicula-overlay">
            <span class="ver-detalles">üëÅÔ∏è Ver Detalles</span>
          </div>
        </div>
        
        <div class="pelicula-info">
          <h3 class="pelicula-titulo">{{ pelicula.titulo }}</h3>
          <p class="pelicula-director">üé¨ {{ pelicula.director }}</p>
          <p class="pelicula-genero">üé≠ {{ pelicula.genero }}</p>
          <p class="pelicula-a√±o">üìÖ {{ pelicula.fecha_estreno | date:'yyyy' }}</p>
          
          <div class="pelicula-rating" *ngIf="pelicula.total_resenas > 0">
            <span class="rating-stars">{{ getEstrellas(getRoundedRating(pelicula.calificacion_promedio)) }}</span>
            <span class="rating-text">({{ pelicula.total_resenas }} rese√±as)</span>
          </div>
          <div class="pelicula-rating" *ngIf="pelicula.total_resenas === 0">
            <span class="no-reviews">Sin rese√±as a√∫n</span>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Paginaci√≥n -->
    <div *ngIf="!loading && !selectedPelicula && peliculasFiltradas.length > 0" class="pagination-container">
      <button 
        (click)="prevPage()" 
        [disabled]="currentPage === 1"
        class="page-btn">
        ‚Üê Anterior
      </button>

      <div class="page-numbers">
        <!-- Mostramos siempre los 5 botones de p√°gina -->
        <button 
          *ngFor="let page of getPaginasVisibles()" 
          (click)="changePage(page)" 
          class="page-number-btn"
          [class.active]="currentPage === page">
          {{ page }}
        </button>
      </div>

      <button 
        (click)="nextPage()" 
        [disabled]="currentPage === totalPages"
        class="page-btn">
        Siguiente ‚Üí
      </button>
    </div>
    
    <!-- Mensaje si no hay pel√≠culas -->
    <div *ngIf="!loading && !selectedPelicula && peliculasFiltradas.length === 0" class="no-movies">
      <h3>üòî No se encontraron pel√≠culas</h3>
      <p *ngIf="searchTerm.trim()">No se encontraron pel√≠culas para "{{searchTerm}}". Intenta con otros t√©rminos de b√∫squeda.</p>
      <p *ngIf="!searchTerm.trim()">No hay pel√≠culas disponibles en este momento</p>
      
    </div>    <!-- Vista de detalle de pel√≠cula -->
    <div *ngIf="selectedPelicula" class="pelicula-detalle">
      <div class="detalle-header">
        <button (click)="cerrarDetalle()" class="btn-back">
          ‚Üê Volver a la galer√≠a
        </button>
        <h2>{{ selectedPelicula.titulo }}</h2>
      </div>

      <div class="detalle-content">
        <div class="detalle-left">
          <img [src]="selectedPelicula.url_imagen || '/assets/no-image.jpg'" [alt]="selectedPelicula.titulo" class="detalle-poster">
          
          <div class="pelicula-stats">
            <div class="stat-item">
              <strong>Director:</strong> {{ selectedPelicula.director }}
            </div>
            <div class="stat-item">
              <strong>G√©nero:</strong> {{ selectedPelicula.genero }}
            </div>
            <div class="stat-item">
              <strong>Fecha de estreno:</strong> {{ selectedPelicula.fecha_estreno | date:'dd/MM/yyyy' }}
            </div>
            <div class="stat-item">
              <strong>Duraci√≥n:</strong> {{ selectedPelicula.duracion }} minutos
            </div>
            <div class="stat-item" *ngIf="selectedPelicula.total_resenas > 0">
              <strong>Calificaci√≥n promedio:</strong> 
              {{ getEstrellas(getRoundedRating(selectedPelicula.calificacion_promedio)) }}
              {{ selectedPelicula.calificacion_promedio ? (selectedPelicula.calificacion_promedio | number:'1.1-1') : '0.0' }}/5
            </div>
            <div class="stat-item">
              <strong>Total de rese√±as:</strong> {{ selectedPelicula.total_resenas }}
            </div>
          </div>

          <button 
            *ngIf="!showResenaForm" 
            (click)="mostrarFormularioResena()" 
            class="btn-escribir-resena">
            ‚úçÔ∏è Escribir Rese√±a
          </button>
        </div>

        <div class="detalle-right">
          <div class="descripcion-section">
            <h3>üìñ Sinopsis</h3>
            <p>{{ selectedPelicula.sinopsis }}</p>
          </div>

          <!-- Formulario de nueva rese√±a -->
          <div *ngIf="showResenaForm" class="resena-form">
            <h3>‚úçÔ∏è Escribir Nueva Rese√±a</h3>
            <div class="form-group">
              <label>Calificaci√≥n:</label>
              <select [(ngModel)]="nuevaResena.calificacion" class="form-select">
                <option value="1">1‚≠ê - Terrible</option>
                <option value="2">2‚≠ê - Malo</option>
                <option value="3">3‚≠ê - Regular</option>
                <option value="4">4‚≠ê - Bueno</option>
                <option value="5">5‚≠ê - Excelente</option>
              </select>
            </div>

            <div class="form-group">
              <label>Tu rese√±a:</label>
              <textarea 
                [(ngModel)]="nuevaResena.resena" 
                placeholder="Escribe tu opini√≥n sobre la pel√≠cula..."
                class="form-textarea"
                rows="4">
              </textarea>
            </div>

            <div class="form-actions">
              <button (click)="enviarResena()" class="btn-primary">
                üìù Enviar Rese√±a
              </button>
              <button (click)="showResenaForm = false; resetFormulario()" class="btn-secondary">
                ‚ùå Cancelar
              </button>
            </div>
          </div>

          <!-- Lista de rese√±as -->
          <div class="resenas-section">
            <h3>üí¨ Rese√±as de la Comunidad</h3>
            
            <div *ngIf="!selectedPelicula.resenas || selectedPelicula.resenas.length === 0" class="no-reviews-message">
              <p>ü§î A√∫n no hay rese√±as para esta pel√≠cula.</p>
              <p>¬°S√© el primero en dejar tu opini√≥n!</p>
            </div>

            <div *ngIf="selectedPelicula.resenas && selectedPelicula.resenas.length > 0" class="resenas-list">
              <div *ngFor="let resena of selectedPelicula.resenas" class="resena-item">
                <div class="resena-header">
                  <div class="resena-user">
                    <strong>üë§ {{ resena.usuario?.name || 'Usuario' }}</strong>
                    <span class="resena-rating">{{ getEstrellas(resena.calificacion) }}</span>
                  </div>
                  <span class="resena-date">
                    üìÖ {{ resena.created_at | date:'dd/MM/yyyy' }}
                  </span>
                </div>
                <p class="resena-text">{{ resena.resena }}</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Paginaci√≥n -->
    <div *ngIf="!selectedPelicula && totalPages > 1" class="pagination">
      <button 
        (click)="changePage(currentPage - 1)" 
        [disabled]="currentPage === 1"
        class="page-btn">
        ‚Üê Anterior
      </button>
      
      <span class="page-info">
        P√°gina {{ currentPage }} de {{ totalPages }}
      </span>
      
      <button 
        (click)="changePage(currentPage + 1)" 
        [disabled]="currentPage === totalPages"
        class="page-btn">
        Siguiente ‚Üí
      </button>
    </div>
  </main>
</div>
